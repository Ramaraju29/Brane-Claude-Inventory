<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InvoiceTracker Pro | Professional Asset Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --accent: #4895ef;
      --success: #4cc9f0;
      --light: #f8f9fa;
      --dark: #212529;
      --light-bg: #f5f7ff;
      --card-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
      --warning: #ff9e00;
      --danger: #e74c3c;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e7f4 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      padding-bottom: 2rem;
    }
    
    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .navbar {
      background: linear-gradient(120deg, var(--primary), var(--secondary));
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      padding: 1rem 2rem;
    }
    
    .card {
      border: none;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      transition: var(--transition);
      overflow: hidden;
      margin-bottom: 1.5rem;
      background: white;
    }
    
    .card-header {
      background: linear-gradient(120deg, var(--primary), var(--accent));
      color: white;
      padding: 1.2rem 1.5rem;
      font-weight: 600;
      font-size: 1.25rem;
	  text-align: center;
    }
    
    .form-control, .form-select {
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      transition: var(--transition);
      font-size: 1rem;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.2);
    }
    
    .btn {
      border-radius: 10px;
      padding: 0.7rem 1.5rem;
      font-weight: 500;
      transition: var(--transition);
      font-size: 1rem;
    }
    
    .btn-primary {
      background: linear-gradient(120deg, var(--primary), var(--secondary));
      border: none;
    }
    
    .btn-primary:hover {
      background: linear-gradient(120deg, var(--secondary), var(--primary));
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(120deg, #2ecc71, #27ae60);
      border: none;
    }
    
    .btn-success:hover {
      background: linear-gradient(120deg, #27ae60, #2ecc71);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
    }
    
    .btn-warning {
      background: linear-gradient(120deg, #ff9e00, #ff7b00);
      border: none;
    }
    
    .btn-warning:hover {
      background: linear-gradient(120deg, #ff7b00, #ff9e00);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 158, 0, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(120deg, #e74c3c, #c0392b);
      border: none;
    }
    
    .btn-danger:hover {
      background: linear-gradient(120deg, #c0392b, #e74c3c);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }
    
    .table {
      border-radius: 10px;
      overflow: hidden;
      font-size: 0.95rem;
    }
    
    .table thead th {
      background: linear-gradient(120deg, var(--primary), var(--accent));
      color: white;
      font-weight: 500;
      padding: 1rem;
	  text-align: center;
    }
	.renewal-table thead th,
.renewal-table tbody td {
  text-align: center;
}
.table thead th,
.table tbody td {
  text-align: center;
}

    
    .table tbody td {
      padding: 0.9rem;
      vertical-align: middle;
    }
    
    .table-hover tbody tr:hover {
      background-color: rgba(67, 97, 238, 0.05);
      transform: scale(1.01);
      transition: transform 0.2s ease;
    }
    
    .processing-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.92);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .processing-overlay.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .spinner {
      width: 70px;
      height: 70px;
      border: 5px solid rgba(67, 97, 238, 0.2);
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.3s, transform 0.3s;
      min-width: 300px;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .upload-area {
      border: 2px dashed #d1d1d1;
      border-radius: 12px;
      padding: 2.5rem;
      text-align: center;
      background: white;
      cursor: pointer;
      transition: var(--transition);
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
    }
    
    .upload-area:hover {
      border-color: var(--accent);
      background: rgba(67, 97, 238, 0.03);
    }
    
    .upload-area i {
      font-size: 3.5rem;
      color: var(--accent);
      margin-bottom: 1rem;
    }
    
    .stats-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--card-shadow);
      text-align: center;
      transition: var(--transition);
      height: 100%;
    }
    
    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .stats-card i {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 1rem;
      background: rgba(67, 97, 238, 0.1);
      width: 70px;
      height: 70px;
      line-height: 70px;
      border-radius: 50%;
    }
    
    .stats-card .value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--dark);
      margin: 0.5rem 0;
    }
    
    .stats-card .label {
      color: #6c757d;
      font-size: 1rem;
    }
    
    .total-amount {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      background: rgba(67, 97, 238, 0.08);
      padding: 0.6rem 1.8rem;
      border-radius: 30px;
      display: inline-flex;
      align-items: center;
      margin: 1rem 0;
    }
    
    .action-btn {
      transition: var(--transition);
    }
    
    .action-btn:hover {
      transform: scale(1.05);
    }
    
    .section-title {
      position: relative;
      padding-bottom: 0.75rem;
      margin-bottom: 1.8rem;
      font-weight: 600;
      color: var(--dark);
    }
    
    .section-title::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 70px;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 2px;
    }
    
    footer {
      background: white;
      padding: 1.5rem 0;
      text-align: center;
      margin-top: 3rem;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      color: #6c757d;
      font-size: 0.95rem;
      box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.03);
    }
    
    .input-group-text {
      background: rgba(67, 97, 238, 0.1);
      border: 1px solid #e0e0e0;
      border-right: none;
    }
    
    .progress-bar {
      height: 8px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      width: 0%;
      transition: width 0.5s ease;
      position: absolute;
      bottom: 0;
      left: 0;
      border-radius: 0 0 10px 10px;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6c757d;
    }
    
    .empty-state i {
      font-size: 4rem;
      color: #dee2e6;
      margin-bottom: 1.5rem;
    }
    
    .status-badge {
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .status-processing {
      background: rgba(52, 152, 219, 0.15);
      color: #2980b9;
    }
    
    .status-complete {
      background: rgba(46, 204, 113, 0.15);
      color: #27ae60;
    }
    
    .bounce {
      animation: bounce 0.5s ease;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .chart-container {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: var(--card-shadow);
      margin-bottom: 1.5rem;
      height: 400px;
      position: relative;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0 0.5rem;
    }
    
    .chart-title {
      font-weight: 600;
      font-size: 1.25rem;
      color: var(--dark);
    }
    
    .chart-controls {
      display: flex;
      gap: 10px;
    }
    
    .chart-btn {
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      background: rgba(67, 97, 238, 0.1);
      border: none;
      color: var(--primary);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .chart-btn:hover {
      background: rgba(67, 97, 238, 0.2);
    }
    
    .chart-btn.active {
      background: var(--primary);
      color: white;
    }
    
    .deploy-guide {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      margin: 2rem 0;
      box-shadow: var(--card-shadow);
    }
    
    .deploy-guide h3 {
      color: var(--primary);
      margin-bottom: 1.5rem;
    }
    
    .deploy-steps {
      counter-reset: step-counter;
      padding-left: 0;
    }
    
    .deploy-steps li {
      list-style: none;
      margin-bottom: 1.5rem;
      position: relative;
      padding-left: 3rem;
    }
    
    .deploy-steps li:before {
      counter-increment: step-counter;
      content: counter(step-counter);
      position: absolute;
      left: 0;
      top: 0;
      width: 2rem;
      height: 2rem;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .btn-deploy {
      background: linear-gradient(120deg, #24292e, #3f4448);
      color: white;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
      margin-top: 1rem;
      transition: var(--transition);
    }
    
    .btn-deploy:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      color: white;
      text-decoration: none;
    }
    
    .chart-first {
      margin-top: 1.5rem;
    }
    
    .renewal-highlight {
      position: relative;
    }
    
    .renewal-highlight::before {
      content: '';
      position: absolute;
      left: -10px;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 80%;
      background: var(--warning);
      border-radius: 3px;
    }
    
    .renewal-table tr {
      transition: all 0.3s ease;
    }
    
    .renewal-table tr:hover {
      background-color: rgba(255, 158, 0, 0.05);
    }
    
    .actions-column {
      display: flex;
      gap: 8px;
    }
    
    .urgent-renewal {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 158, 0, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(255, 158, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 158, 0, 0); }
    }
    
    .status-urgent {
      background: rgba(255, 158, 0, 0.15);
      color: #ff9e00;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-upcoming {
      background: rgba(52, 152, 219, 0.15);
      color: #3498db;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <i class="fas fa-file-invoice-dollar me-2"></i>
        <span class="fw-bold">Brane- Claude InvoiceTracker Pro</span>
      </a>
      <div class="d-flex align-items-center">
        <div class="text-white me-4 d-none d-md-block">
          <i class="fas fa-user-circle me-2"></i>
          <span>Admin User</span>
        </div>
        <button class="btn btn-outline-light">
          <i class="fas fa-cog"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="app-container mt-4">
    <!-- Claude API Utilization Chart at the TOP -->
    <div class="card fade-in chart-first">
      <div class="card-header d-flex align-items-center">
        <i class="fas fa-chart-bar me-3"></i>
        <span>Claude API Credit Utilization</span>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Monthly Credit Utilization by User</div>
            <div class="chart-controls">
              <button class="chart-btn active" id="chart6Months">6 Months</button>
              <button class="chart-btn" id="chart12Months">12 Months</button>
            </div>
          </div>
          <canvas id="claudeUtilizationChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-md-3 mb-4">
        <div class="stats-card fade-in">
          <i class="fas fa-file-invoice"></i>
          <div class="value" id="totalInvoices">0</div>
          <div class="label">Total Invoices</div>
        </div>
      </div>
      <div class="col-md-3 mb-4">
        <div class="stats-card fade-in">
          <i class="fas fa-dollar-sign"></i>
          <div class="value" id="totalAmountValue">$0.00</div>
          <div class="label">Total Value</div>
        </div>
      </div>
      <div class="col-md-3 mb-4">
        <div class="stats-card fade-in">
          <i class="fas fa-users"></i>
          <div class="value" id="totalUsers">0</div>
          <div class="label">Active Users</div>
        </div>
      </div>
      <div class="col-md-3 mb-4">
        <div class="stats-card fade-in">
          <i class="fas fa-shapes"></i>
          <div class="value" id="assetTypes">0</div>
          <div class="label">Asset Types</div>
        </div>
      </div>
    </div>
	
	<div class="card mt-4">
  <div class="card-header bg-secondary text-white text-center">Recycle Bin</div>
  <div class="card-body">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>User ID</th>
          <th>Email ID</th>
          <th>Invoice #</th>
          <th>Invoice Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="recycleBinTable"></tbody>
    </table>
  </div>
</div>


    <!-- Upload Section -->
    <div class="card mb-4 fade-in">
      <div class="card-header d-flex align-items-center">
        <i class="fas fa-cloud-upload-alt me-3"></i>
        <span>Upload Invoice & Auto-Fill Form</span>
      </div>
      <div class="card-body">
        <div class="upload-area" id="uploadArea">
          <i class="fas fa-file-pdf"></i>
          <h4>Drag & Drop Invoice PDF Here</h4>
          <p class="text-muted mb-4">or click to browse files (PDF only)</p>
          <input type="file" id="invoiceUpload" class="d-none" accept=".pdf">
          <div class="progress-bar" id="uploadProgress"></div>
        </div>

        <div class="d-flex justify-content-center mb-4">
          <div class="status-badge status-processing d-none" id="processingStatus">
            <i class="fas fa-spinner fa-spin me-2"></i> Processing invoice...
          </div>
          <div class="status-badge status-complete d-none" id="completeStatus">
            <i class="fas fa-check-circle me-2"></i> Data extracted successfully!
          </div>
        </div>

        <!-- Form Section -->
        <form id="assetForm">
          <div class="row mb-3">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-medium">User ID</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-user"></i></span>
                <input type="text" id="userId" class="form-control">
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-medium">Email ID</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                <input type="email" id="emailId" class="form-control">
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4 mb-3">
              <label class="form-label fw-medium">Invoice Number</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-hashtag"></i></span>
                <input type="text" id="invoiceNumber" class="form-control">
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label fw-medium">Invoice Date</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                <input type="date" id="invoiceDate" class="form-control">
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label fw-medium">Invoice Amount</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-dollar-sign"></i></span>
                <input type="text" id="invoiceAmount" class="form-control">
              </div>
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label fw-medium">Asset Type</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-cube"></i></span>
              <input type="text" class="form-control" id="assetType">
            </div>
          </div>

          <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-success btn-lg action-btn px-4" id="saveBtn">
              <i class="fas fa-save me-2"></i> Save Entry
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Upcoming Renewals Section -->
    <div class="card mb-4 fade-in">
      <div class="card-header d-flex align-items-center">
        <i class="fas fa-calendar-check me-3"></i>
        <span>Upcoming Renewals</span>
      </div>
      <div class="card-body">
       <div class="mb-4">
  <h5 class="mb-0">All Pro & Max Pro Renewals</h5>
  <p class="text-muted mb-0">Track and manage all upcoming subscription renewals</p>
</div>

        
        <div class="table-responsive">
          <table class="table table-hover align-middle renewal-table">
            <thead>
              <tr>
                <th><i class="fas fa-user me-1"></i> User ID</th>
                <th><i class="fas fa-envelope me-1"></i> Email ID</th>
                <th><i class="fas fa-calendar-day me-1"></i> Renewal Date</th>
                <th><i class="fas fa-cube me-1"></i> Asset Type</th>
                <th><i class="fas fa-bolt me-1"></i> Status</th>
                <th><i class="fas fa-cog me-1"></i> Actions</th>
              </tr>
            </thead>
            <tbody id="renewalsTable">
              <tr>
                <td colspan="6" class="text-center py-5">
                  <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <h5 class="mb-2">No Upcoming Renewals</h5>
                    <p class="text-muted">All renewals are up to date</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Filter & Export Section -->
    <div class="card fade-in">
      <div class="card-header d-flex align-items-center">
        <i class="fas fa-filter me-3"></i>
        <span>Filter & Export Data</span>
      </div>
      <div class="card-body">
        <div class="row mb-4">
          <div class="col-md-3 mb-3">
            <label class="form-label fw-medium">Filter by Month</label>
            <input type="month" id="filterMonth" class="form-control">
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label fw-medium">Filter by User ID</label>
            <input type="text" list="userIdList" id="filterUserId" class="form-control" placeholder="Enter User ID">
            <datalist id="userIdList"></datalist>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label fw-medium">Filter by Email</label>
            <input type="text" list="emailList" id="filterEmail" class="form-control" placeholder="Enter Email">
            <datalist id="emailList"></datalist>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label fw-medium">Filter by Asset Type</label>
            <input type="text" list="typeList" id="filterType" class="form-control" placeholder="Enter Asset Type">
            <datalist id="typeList"></datalist>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
          <div class="d-flex mb-3 mb-md-0">
            <button class="btn btn-primary me-3 action-btn px-4" onclick="renderTable()">
              <i class="fas fa-search me-2"></i> Apply Filters
            </button>
            <button class="btn btn-outline-primary action-btn px-4" onclick="exportCSV()">
              <i class="fas fa-file-export me-2"></i> Export CSV
            </button>
          </div>
          <div class="total-amount">
            <i class="fas fa-coins me-2"></i> Total: <span id="totalAmountDisplay">$0.00</span>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th><i class="fas fa-user me-1"></i> User ID</th>
                <th><i class="fas fa-envelope me-1"></i> Email ID</th>
                <th><i class="fas fa-hashtag me-1"></i> Invoice #</th>
                <th><i class="fas fa-calendar me-1"></i> Date</th>
                <th><i class="fas fa-dollar-sign me-1"></i> Amount</th>
                <th><i class="fas fa-cube me-1"></i> Asset Type</th>
                <th><i class="fas fa-cog me-1"></i> Action</th>
              </tr>
            </thead>
            <tbody id="dataTable">
              <tr>
                <td colspan="7" class="text-center py-5">
                  <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h5 class="mb-2">No Invoice Data</h5>
                    <p class="text-muted">Upload your first invoice to get started</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Processing Overlay -->
  <div class="processing-overlay" id="processingOverlay">
    <div class="text-center">
      <div class="spinner"></div>
      <h3 class="mt-4">Processing Invoice...</h3>
      <p class="text-muted mt-2">Extracting data from your document</p>
      <div class="mt-3">
        <div class="progress mt-3" style="height: 8px; max-width: 400px; margin: 0 auto;">
          <div class="progress-bar" id="ocrProgressBar" style="width: 0%"></div>
        </div>
        <p class="text-muted mt-2" id="progressText">Initializing OCR engine...</p>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast" id="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header bg-primary text-white">
      <strong class="me-auto" id="toastTitle">Notification</strong>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastMessage">
      This is a toast message
    </div>
  </div>

  <footer>
    <div class="container">
      <p class="mb-0">InvoiceTracker Pro &copy; 2023 | Claude API Utilization Dashboard</p>
    </div>
  </footer>

  <canvas id="pdf-canvas" style="display:none;"></canvas>

<script>
  // Initialize elements
  const processingOverlay = document.getElementById("processingOverlay");
  const uploadArea = document.getElementById("uploadArea");
  const invoiceUpload = document.getElementById("invoiceUpload");
  const uploadProgress = document.getElementById("uploadProgress");
  const toast = document.getElementById("toast");
  const toastTitle = document.getElementById("toastTitle");
  const toastMessage = document.getElementById("toastMessage");
  const processingStatus = document.getElementById("processingStatus");
  const completeStatus = document.getElementById("completeStatus");
  const ocrProgressBar = document.getElementById("ocrProgressBar");
  const progressText = document.getElementById("progressText");
  let claudeChart = null;

  // API endpoints
  const API_ENDPOINTS = {
    getInvoices: '/.netlify/functions/getInvoices',
    saveInvoice: '/.netlify/functions/saveInvoice',
    deleteInvoice: '/.netlify/functions/deleteInvoice',
    restoreInvoice: '/.netlify/functions/restoreInvoice',
    renewInvoice: '/.netlify/functions/renewInvoice'
  };

  // Upload area click event
  uploadArea.addEventListener("click", () => {
    invoiceUpload.click();
  });

  // Drag and drop functionality
  uploadArea.addEventListener("dragover", (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = "#4361ee";
    uploadArea.style.backgroundColor = "#f0f5ff";
  });

  uploadArea.addEventListener("dragleave", () => {
    uploadArea.style.borderColor = "#d1d1d1";
    uploadArea.style.backgroundColor = "white";
  });

  uploadArea.addEventListener("drop", (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = "#d1d1d1";
    uploadArea.style.backgroundColor = "white";
    
    if (e.dataTransfer.files.length) {
      invoiceUpload.files = e.dataTransfer.files;
      handleInvoiceUpload();
    }
  });

  // Handle file upload
  invoiceUpload.addEventListener("change", handleInvoiceUpload);
  
  function handleInvoiceUpload() {
    const file = invoiceUpload.files[0];
    if (!file || file.type !== "application/pdf") {
      showToast("Error", "Please upload a valid PDF file", "danger");
      return;
    }

    // Show processing UI
    processingStatus.classList.remove("d-none");
    completeStatus.classList.add("d-none");
    processingOverlay.classList.add("active");
    uploadProgress.style.width = "0%";

    // Process the invoice
    processInvoice(file);
  }

  function processInvoice(file) {
    const reader = new FileReader();
    reader.onload = () => {
      const typedarray = new Uint8Array(reader.result);
      
      // Update progress
      updateProgress(20, "Loading PDF document...");
      
      pdfjsLib.getDocument(typedarray).promise.then(pdf => {
        updateProgress(40, "Rendering PDF page...");
        
        pdf.getPage(1).then(page => {
          const canvas = document.getElementById("pdf-canvas");
          const context = canvas.getContext("2d");
          const viewport = page.getViewport({ scale: 2.0 });
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          
          page.render({ canvasContext: context, viewport: viewport }).promise.then(() => {
            updateProgress(60, "Performing OCR...");
            
            Tesseract.recognize(canvas, 'eng', {
              logger: progress => {
                if (progress.status === "recognizing text") {
                  const pct = 60 + Math.floor(progress.progress * 30);
                  updateProgress(pct, `Processing text: ${Math.floor(progress.progress * 100)}%`);
                }
              }
            }).then(({ data: { text } }) => {
              updateProgress(95, "Extracting data...");
              
              // Extract data using regex
              const emailRegex = /([a-zA-Z0-9._%+-]+@braneenterprises\.com)/gi;
              const emailMatch = text.match(emailRegex);
              const braneEmail = emailMatch && emailMatch.length > 0 ? emailMatch[0].trim().toLowerCase() : "";
              
              const invoiceMatch = text.match(/(?:invoice\s*(?:number)?[:#]?\s*)([A-Z0-9\-]{5,})/i);
              
              const dateMatch = text.match(/\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*[\s.,-]*\d{1,2},?[\s.,-]*\d{4}\b/i);
              let invoiceDate = "";
              if (dateMatch) {
                invoiceDate = new Date(dateMatch[0]).toISOString().split("T")[0];
              }
              
              const amountMatch = text.match(/(\$|USD)\s?(\d+(?:,\d{3})*(?:\.\d{2})?)/i);
              
              const lower = text.toLowerCase();
              let assetType = "";
              if (lower.includes("max plan - 5x")) assetType = "Max Pro (100$)";
              else if (lower.includes("claude pro")) assetType = "Pro (20$)";
              else if (lower.includes("one-time credit purchase")) assetType = "Claude API";
              
              // Populate form
              document.getElementById('emailId').value = braneEmail;
              document.getElementById('userId').value = braneEmail ? braneEmail.split("@")[0] : "";
              document.getElementById('invoiceNumber').value = invoiceMatch?.[1]?.trim() || "";
              document.getElementById('invoiceDate').value = invoiceDate;
              document.getElementById('invoiceAmount').value = amountMatch ? amountMatch[0] : "";
              document.getElementById('assetType').value = assetType;
              
              // Update UI
              setTimeout(() => {
                processingOverlay.classList.remove("active");
                processingStatus.classList.add("d-none");
                completeStatus.classList.remove("d-none");
                uploadProgress.style.width = "100%";
                
                showToast("Success", "Invoice data extracted successfully!", "success");
                
                // Animate form fields
                document.querySelectorAll('#assetForm input').forEach(input => {
                  if (input.value) {
                    input.classList.add('bounce');
                    setTimeout(() => input.classList.remove('bounce'), 1000);
                  }
                });
              }, 500);
            });
          });
        });
      });
    };
    reader.readAsArrayBuffer(file);
  }

  function updateProgress(pct, message) {
    ocrProgressBar.style.width = `${pct}%`;
    progressText.textContent = message;
  }

  // Save button click event
  document.getElementById("saveBtn").addEventListener("click", async () => {
    const required = ['emailId', 'userId', 'invoiceNumber', 'invoiceDate', 'invoiceAmount', 'assetType'];
    const emptyFields = required.filter(id => !document.getElementById(id).value);

    if (emptyFields.length > 0) {
      showToast("Validation Error", "Please fill in all required fields", "danger");
      emptyFields.forEach(id => {
        const field = document.getElementById(id);
        field.classList.add('bounce');
        setTimeout(() => field.classList.remove('bounce'), 1000);
      });
      return;
    }

    const entry = {
      userId: document.getElementById('userId').value,
      emailId: document.getElementById('emailId').value,
      invoiceNumber: document.getElementById('invoiceNumber').value,
      invoiceDate: document.getElementById('invoiceDate').value,
      invoiceAmount: document.getElementById('invoiceAmount').value,
      assetType: document.getElementById('assetType').value
    };

    try {
      // Save to DB
      const res = await fetch(API_ENDPOINTS.saveInvoice, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(entry)
      });

      if (!res.ok) throw new Error("Failed to save");

      showToast("Success", "Entry saved successfully!", "success");
      document.getElementById("assetForm").reset();

      // Reload UI from DB
      await renderTable();
      await updateStats();
      await populateAutocomplete();
      await renderClaudeChart(6);
      await renderUpcomingRenewals();
      await renderRecycleBin();

    } catch (err) {
      console.error(err);
      showToast("Error", "Failed to save entry", "danger");
    }
  });

  // Show toast notification
  function showToast(title, message, type = "info") {
    toastTitle.textContent = title;
    toastMessage.textContent = message;
    
    // Set toast color based on type
    const headerClass = {
      "success": "bg-success text-white",
      "danger": "bg-danger text-white",
      "info": "bg-primary text-white",
      "warning": "bg-warning text-white"
    }[type] || "bg-primary text-white";
    
    toast.querySelector(".toast-header").className = `toast-header ${headerClass}`;
    
    // Show toast with animation
    toast.classList.add("show");
    
    // Hide after 3 seconds
    setTimeout(() => {
      toast.classList.remove("show");
    }, 3000);
  }

  // Initialize datalist values on load
  window.addEventListener('DOMContentLoaded', () => {
    populateAutocomplete();
    renderTable();
    updateStats();
    renderClaudeChart(6);
    renderUpcomingRenewals();
    renderRecycleBin();
    
    // Add chart period controls
    document.getElementById('chart6Months').addEventListener('click', () => {
      document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('chart6Months').classList.add('active');
      renderClaudeChart(6);
    });
    
    document.getElementById('chart12Months').addEventListener('click', () => {
      document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('chart12Months').classList.add('active');
      renderClaudeChart(12);
    });
  });

  // Fetch data from database
  async function fetchInvoices(includeDeleted = false) {
    try {
      const response = await fetch(API_ENDPOINTS.getInvoices);
      if (!response.ok) throw new Error('Failed to fetch invoices');
      
      const data = await response.json();
      // Filter out deleted items if needed
      return includeDeleted ? data : data.filter(item => !item.isdeleted);
    } catch (error) {
      console.error('Error fetching invoices:', error);
      showToast("Error", "Failed to load data from server", "danger");
      return [];
    }
  }

  async function updateStats() {
    const data = await fetchInvoices();
    document.getElementById("totalInvoices").textContent = data.length;
    
    const users = new Set(data.map(e => e.userid));
    document.getElementById("totalUsers").textContent = users.size;
    
    const types = new Set(data.map(e => e.assettype));
    document.getElementById("assetTypes").textContent = types.size;
    
    let total = 0;
    data.forEach(entry => {
      const amt = parseFloat(entry.invoiceamount.replace(/[^\d.]/g, "")) || 0;
      total += amt;
    });
    
    document.getElementById("totalAmountValue").textContent = `$${total.toFixed(2)}`;
    document.getElementById("totalAmountDisplay").textContent = `$${total.toFixed(2)}`;
  }

  async function renderTable() {
    const data = await fetchInvoices();
    const tbody = document.getElementById("dataTable");
    
    if (data.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center py-5">
            <div class="empty-state">
              <i class="fas fa-inbox"></i>
              <h5 class="mb-2">No Invoice Data</h5>
              <p class="text-muted">Upload your first invoice to get started</p>
            </div>
          </td>
        </tr>
      `;
      document.getElementById("totalAmountDisplay").textContent = "$0.00";
      return;
    }
    
    tbody.innerHTML = "";
    let total = 0;
    const month = document.getElementById("filterMonth").value;
    const userId = document.getElementById("filterUserId").value.toLowerCase();
    const email = document.getElementById("filterEmail").value.toLowerCase();
    const type = document.getElementById("filterType").value.toLowerCase();

    data.forEach(entry => {
      if (month && !entry.invoicedate.startsWith(month)) return;
      if (userId && !entry.userid.toLowerCase().includes(userId)) return;
      if (email && !entry.emailid.toLowerCase().includes(email)) return;
      if (type && !entry.assettype.toLowerCase().includes(type)) return;

      const amt = parseFloat(entry.invoiceamount.replace(/[^\d.]/g, "")) || 0;
      total += amt;
      
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${entry.userid}</td>
        <td>${entry.emailid}</td>
        <td>${entry.invoicenumber}</td>
        <td>${entry.invoicedate}</td>
        <td>${entry.invoiceamount}</td>
        <td>${entry.assettype}</td>
        <td>
          <button class='btn btn-sm btn-danger action-btn' onclick='deleteEntry("${entry.invoicenumber}")'>
            <i class='fas fa-trash me-1'></i> Delete
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("totalAmountDisplay").textContent = `$${total.toFixed(2)}`;
  }

  async function populateAutocomplete() {
    const data = await fetchInvoices();
    const userIds = [...new Set(data.map(e => e.userid))];
    const emails = [...new Set(data.map(e => e.emailid))];
    const types = [...new Set(data.map(e => e.assettype))];

    document.getElementById("userIdList").innerHTML = userIds.map(id => `<option value="${id}">`).join("");
    document.getElementById("emailList").innerHTML = emails.map(id => `<option value="${id}">`).join("");
    document.getElementById("typeList").innerHTML = types.map(id => `<option value="${id}">`).join("");
  }

  async function exportCSV() {
    const data = await fetchInvoices();
    if (data.length === 0) {
      showToast("Export Error", "No data available to export", "danger");
      return;
    }
    
    const rows = [
      ["User ID", "Email ID", "Invoice #", "Date", "Amount", "Asset Type"]
    ];
    
    const month = document.getElementById("filterMonth").value;
    const userId = document.getElementById("filterUserId").value.toLowerCase();
    const email = document.getElementById("filterEmail").value.toLowerCase();
    const type = document.getElementById("filterType").value.toLowerCase();

    data.forEach(entry => {
      if (month && !entry.invoicedate.startsWith(month)) return;
      if (userId && !entry.userid.toLowerCase().includes(userId)) return;
      if (email && !entry.emailid.toLowerCase().includes(email)) return;
      if (type && !entry.assettype.toLowerCase().includes(type)) return;
      rows.push([entry.userid, entry.emailid, entry.invoicenumber, entry.invoicedate, entry.invoiceamount, entry.assettype]);
    });

    const csv = rows.map(row => row.join(",")).join("\n");
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'invoice_data.csv';
    a.click();
    
    showToast("Export Successful", "CSV file downloaded", "success");
  }

  async function deleteEntry(invoiceNumber) {
    try {
      const response = await fetch(API_ENDPOINTS.deleteInvoice, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ invoiceNumber })
      });

      if (!response.ok) throw new Error("Failed to delete invoice");

      showToast("Moved to Recycle Bin", "Invoice has been deleted", "warning");
      
      // Refresh the UI
      renderTable();
      renderRecycleBin();
      updateStats();
      renderUpcomingRenewals();
    } catch (error) {
      console.error("Error deleting invoice:", error);
      showToast("Error", "Failed to delete invoice", "danger");
    }
  }

  async function restoreEntry(invoiceNumber) {
    try {
      const response = await fetch(API_ENDPOINTS.restoreInvoice, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ invoiceNumber })
      });

      if (!response.ok) throw new Error("Failed to restore invoice");

      showToast("Restored", "Invoice has been restored", "success");
      
      // Refresh the UI
      renderTable();
      renderRecycleBin();
      updateStats();
      renderUpcomingRenewals();
    } catch (error) {
      console.error("Error restoring invoice:", error);
      showToast("Error", "Failed to restore invoice", "danger");
    }
  }

  async function permanentlyDeleteEntry(invoiceNumber) {
    const enteredPassword = prompt("Enter password to permanently delete this entry:");
    if (enteredPassword !== "P@ssword29") {
      showToast("Access Denied", "Incorrect password. Entry not deleted.", "danger");
      return;
    }

    // For permanent deletion, we'll need to implement a separate function
    // For now, we'll just use the standard delete which marks as deleted
    await deleteEntry(invoiceNumber);
    showToast("Deleted", "Invoice has been permanently removed", "danger");
  }

  async function renderRecycleBin() {
    const data = await fetchInvoices(true); // Include deleted items
    const deletedData = data.filter(item => item.isdeleted);
    const binTable = document.getElementById("recycleBinTable");

    if (deletedData.length === 0) {
      binTable.innerHTML = "<tr><td colspan='6' class='text-center'>Recycle Bin is empty</td></tr>";
      return;
    }

    binTable.innerHTML = "";
    deletedData.forEach(entry => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${entry.userid}</td>
        <td>${entry.emailid}</td>
        <td>${entry.invoicenumber}</td>
        <td>${entry.invoicedate}</td>
        <td>
          <button class='btn btn-sm btn-success' onclick="restoreEntry('${entry.invoicenumber}')">Restore</button>
          <button class='btn btn-sm btn-danger' onclick="permanentlyDeleteEntry('${entry.invoicenumber}')">Delete</button>
        </td>
      `;
      binTable.appendChild(tr);
    });
  }

  // Calculate renewal date (1 month from invoice date)
  async function renderUpcomingRenewals() {
    const data = await fetchInvoices();
    const renewalsTable = document.getElementById("renewalsTable");
    const today = new Date();

    // Filter only Pro & Max Pro
    const proData = data.filter(entry =>
      entry.assettype && entry.assettype.toLowerCase().includes("pro")
    );

    // Get latest invoice per user
    const latestInvoices = {};
    proData.forEach(entry => {
      if (!latestInvoices[entry.userid] ||
          new Date(entry.invoicedate) > new Date(latestInvoices[entry.userid].invoicedate)) {
        latestInvoices[entry.userid] = entry;
      }
    });

    const filtered = Object.values(latestInvoices).filter(entry => {
      const dueDateObj = new Date(entry.invoicedate);
      dueDateObj.setDate(dueDateObj.getDate() + 30); // due date

      const overdueLimit = new Date(dueDateObj);
      overdueLimit.setDate(overdueLimit.getDate() + 30); // last date to show

      // Show if today is before overdue limit
      return today <= overdueLimit;
    });

    if (filtered.length === 0) {
      renewalsTable.innerHTML = `
        <tr>
          <td colspan="6" class="text-center py-5">
            <div class="empty-state">
              <i class="fas fa-check-circle"></i>
              <h5 class="mb-2">No Upcoming Renewals</h5>
              <p class="text-muted">No Pro or Max Pro subscriptions nearing expiry</p>
            </div>
          </td>
        </tr>
      `;
      return;
    }

    renewalsTable.innerHTML = "";
    filtered.forEach(entry => {
      const dueDateObj = new Date(entry.invoicedate);
      dueDateObj.setDate(dueDateObj.getDate() + 30);
      const dueDateStr = dueDateObj.toISOString().split("T")[0];

      const diffDays = Math.ceil((dueDateObj - today) / (1000 * 60 * 60 * 24));

      let rowColor = "";
      if (diffDays < 0) {
        rowColor = "table-danger"; // overdue
      } else if (diffDays <= 7) {
        rowColor = "table-warning"; // due within 7 days
      } else {
        rowColor = "table-success"; // due in more than 7 days
      }

      const tr = document.createElement("tr");
      tr.classList.add(rowColor);

      tr.innerHTML = `
        <td>${entry.userid}</td>
        <td>${entry.emailid}</td>
        <td>${dueDateStr}</td>
        <td>${entry.assettype}</td>
        <td>${
          diffDays < 0
            ? "Overdue by " + Math.abs(diffDays) + " days"
            : diffDays + " days left"
        }</td>
        <td class="actions-column">
          <button class='btn btn-sm btn-warning action-btn renew-btn' 
                  data-userid="${entry.userid}" 
                  data-date="${dueDateStr}">
            <i class='fas fa-external-link-alt me-1'></i> Renew
          </button>
          <button class='btn btn-sm btn-success action-btn done-btn' 
                  data-userid="${entry.userid}" 
                  data-date="${dueDateStr}">
            <i class='fas fa-check me-1'></i> Done
          </button>
        </td>
      `;
      renewalsTable.appendChild(tr);
    });

    // Renew button
    document.querySelectorAll('.renew-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        window.open('https://claude.ai/', '_blank');
      });
    });

    // Done button
    document.querySelectorAll('.done-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const userId = this.dataset.userid;
        const renewalDate = this.dataset.date;
        // This would need to be stored in the database in a real implementation
        showToast("Renewal Marked Complete", "This renewal has been marked as done", "success");
      });
    });
  }

  async function renderClaudeChart(monthsCount) {
    const data = await fetchInvoices();
    
    // Filter only Claude API entries
    const claudeData = data.filter(entry => 
      entry.assettype && entry.assettype.includes("Claude")
    );
    
    if (claudeData.length === 0) {
      // No Claude API data - show message
      const ctx = document.getElementById('claudeUtilizationChart').getContext('2d');
      
      if (claudeChart) {
        claudeChart.destroy();
      }
      
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      ctx.fillStyle = '#6c757d';
      ctx.textAlign = 'center';
      ctx.font = '16px Arial';
      ctx.fillText('No Claude API data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
      return;
    }
    
    // Get current date
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();
    
    // Create month labels
    const monthLabels = [];
    const monthKeys = [];
    
    for (let i = monthsCount - 1; i >= 0; i--) {
      const date = new Date(currentYear, currentMonth - i, 1);
      const monthName = date.toLocaleString('default', { month: 'short' });
      const year = date.getFullYear();
      const key = `${year}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
      
      monthLabels.push(`${monthName} ${year}`);
      monthKeys.push(key);
    }
    
    // Get top users (up to 5 for chart readability)
    const users = [...new Set(claudeData.map(entry => entry.userid))].slice(0, 5);
    
    // Prepare dataset
    const datasets = users.map(user => {
      // Generate random color for each user
      const color = `hsl(${Math.floor(Math.random() * 360)}, 70%, 60%)`;
      
      const userData = monthKeys.map(month => {
        const entries = claudeData.filter(entry => 
          entry.userid === user && 
          entry.invoicedate.startsWith(month)
        );
        
        return entries.reduce((sum, entry) => {
          const amount = parseFloat(entry.invoiceamount.replace(/[^\d.]/g, "")) || 0;
          return sum + amount;
        }, 0);
      });
      
      return {
        label: user,
        backgroundColor: color,
        data: userData
      };
    });
    
    // Create or update chart
    const ctx = document.getElementById('claudeUtilizationChart').getContext('2d');
    
    if (claudeChart) {
      claudeChart.destroy();
    }
    
    claudeChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: monthLabels,
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Monthly Claude API Credit Utilization',
            font: {
              size: 16
            }
          },
          legend: {
            position: 'top',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.dataset.label}: $${context.raw.toFixed(2)}`;
              }
            }
          }
        },
        scales: {
          x: {
            stacked: false,
            grid: {
              display: false	
            },
            title: {
              display: true,
              text: 'Month'
            }
          },
          y: {
            stacked: false,
            beginAtZero: true,
            title: {
              display: true,
              text: 'Amount ($)'
            }
          }
        },
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        }
      }
    });
  }

  // Add fade-in animations to cards on load
  document.querySelectorAll('.fade-in').forEach((el, index) => {
    el.style.animationDelay = `${index * 0.1}s`;
  });
</script>
</body>
</html>